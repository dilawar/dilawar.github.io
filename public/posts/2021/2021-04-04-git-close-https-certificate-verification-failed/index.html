<!doctype html><html lang=en><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=UTF-8><title>Fixing git clone over https - Server certificate verification failed | Dilawar's Blog</title>
<meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=generator content="Hugo 0.131.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Dilawar Singh"><link rel=stylesheet type=text/css media=screen href=/css/normalize.css><link rel=stylesheet type=text/css media=screen href=/css/main.css><link rel=stylesheet type=text/css media=screen href=/css/all.css><link rel=stylesheet href=/css/katex.css crossorigin=anonymous><script defer src=/js/katex.js integrity=sha384-PFWG8XW41D5NzhNv5FegM1CUkw9nNLdWug8DuwnUoNEVop9n5frjcnbtsZtxTNjw crossorigin=anonymous></script><script defer src=/js/auto-render.js integrity=sha384-EN2q+JG5/3Z8gD7hT5WZqq+W+9wQR4P3IezfuZmGG5RkNXaaaks85seDJO7WkZlY crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><meta property="og:url" content="http://localhost:1313/posts/2021/2021-04-04-git-close-https-certificate-verification-failed/"><meta property="og:site_name" content="Dilawar's Blog"><meta property="og:title" content="Fixing git clone over https - Server certificate verification failed"><meta property="og:description" content="As soon as I try to clone using git clone https://gitlab.subcom.tech/subcom/voicedb, I run into the following problem:
admin@ip-172-26-13-71:~/Work$ git clone https://gitlab.subcom.tech/subcom/voicedb.git Cloning into 'voicedb'... fatal: unable to access 'https://gitlab.subcom.tech/subcom/voicedb.git/': server certificate verification failed. CAfile: none CRLfile: none This is a big problem. The only protocol which works out of box is ssh. To use ssh protocol, everyone has to upload public key to the server. A bit of hassle if you are not working on your own machine :sad:."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta name=twitter:card content="summary"><meta name=twitter:title content="Fixing git clone over https - Server certificate verification failed"><meta name=twitter:description content="As soon as I try to clone using git clone https://gitlab.subcom.tech/subcom/voicedb, I run into the following problem:
admin@ip-172-26-13-71:~/Work$ git clone https://gitlab.subcom.tech/subcom/voicedb.git Cloning into 'voicedb'... fatal: unable to access 'https://gitlab.subcom.tech/subcom/voicedb.git/': server certificate verification failed. CAfile: none CRLfile: none This is a big problem. The only protocol which works out of box is ssh. To use ssh protocol, everyone has to upload public key to the server. A bit of hassle if you are not working on your own machine :sad:."><meta itemprop=name content="Fixing git clone over https - Server certificate verification failed"><meta itemprop=description content="As soon as I try to clone using git clone https://gitlab.subcom.tech/subcom/voicedb, I run into the following problem:
admin@ip-172-26-13-71:~/Work$ git clone https://gitlab.subcom.tech/subcom/voicedb.git Cloning into 'voicedb'... fatal: unable to access 'https://gitlab.subcom.tech/subcom/voicedb.git/': server certificate verification failed. CAfile: none CRLfile: none This is a big problem. The only protocol which works out of box is ssh. To use ssh protocol, everyone has to upload public key to the server. A bit of hassle if you are not working on your own machine :sad:."><meta itemprop=wordCount content="808"></head><body><header><div id=titletext><h2 id=title><a href=http://localhost:1313/>Dilawar's Blog</a></h2></div><div id=title-description><p id=subtitle>watch -n 1 /dev/null</p><div id=social><nav><ul><li><a href=https://github.com/dilawar><i title=Github class="icons fab fa-github"></i></a></li><li><a href=mailto:dilawar.s.rajput@gmail.com><i title=Email class="icons fab fa-envelope"></i></a></li><li><a><i title="Switch Dark Mode" class="dark-mode icons fas fa-moon"></i></a></li></ul></nav></div></div><div id=mainmenu><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/about>About</a></li><li><a href=/tags>Tags</a></li></ul></nav></div></header><main><div class=post><article><div class=post-header><div class=matter><h1 class=title>Fixing git clone over https - Server certificate verification failed</h1><p class=post-meta><span class=post-meta><i class="fas fa-user"></i>&nbsp;
Dilawar Singh</span></p></div></div><div class=markdown><p>As soon as I try to clone using <code>git clone https://gitlab.subcom.tech/subcom/voicedb</code>, I run into the following problem:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>admin@ip-172-26-13-71:~/Work$ git clone https://gitlab.subcom.tech/subcom/voicedb.git
</span></span><span style=display:flex><span>Cloning into <span style=color:#e6db74>&#39;voicedb&#39;</span>...
</span></span><span style=display:flex><span>fatal: unable to access <span style=color:#e6db74>&#39;https://gitlab.subcom.tech/subcom/voicedb.git/&#39;</span>: server certificate verification failed. CAfile: none CRLfile: none
</span></span></code></pre></div><p>This is a big problem. The only protocol which works out of box is ssh. To use ssh protocol, everyone has to upload public key to the server. A bit of hassle if you are not working on your own machine :sad:.</p><p>First thing first, there is an issue with certificate. Lets debug this.</p><h2 id=check-for-certificates>Check for certificates</h2><p>First, I&rsquo;d like to know how certificates behaves on a working site.</p><h3 id=base-case-githubcom-certificates>Base case: github.com certificates.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>admin@ip-172-26-7-193:~$ openssl s_client -showcerts -servername github.com -connect github.com:443 &lt;/dev/null 2&gt;/dev/null
</span></span><span style=display:flex><span>CONNECTED<span style=color:#f92672>(</span>00000003<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>Certificate chain
</span></span><span style=display:flex><span> <span style=color:#ae81ff>0</span> s:C <span style=color:#f92672>=</span> US, ST <span style=color:#f92672>=</span> California, L <span style=color:#f92672>=</span> San Francisco, O <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;GitHub, Inc.&#34;</span>, CN <span style=color:#f92672>=</span> github.com
</span></span><span style=display:flex><span>   i:C <span style=color:#f92672>=</span> US, O <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;DigiCert, Inc.&#34;</span>, CN <span style=color:#f92672>=</span> DigiCert High Assurance TLS Hybrid ECC SHA256 <span style=color:#ae81ff>2020</span> CA1
</span></span><span style=display:flex><span>-----BEGIN CERTIFICATE-----
</span></span><span style=display:flex><span>... redacted ...
</span></span><span style=display:flex><span>-----END CERTIFICATE-----
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1</span> s:C <span style=color:#f92672>=</span> US, O <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;DigiCert, Inc.&#34;</span>, CN <span style=color:#f92672>=</span> DigiCert High Assurance TLS Hybrid ECC SHA256 <span style=color:#ae81ff>2020</span> CA1
</span></span><span style=display:flex><span>   i:C <span style=color:#f92672>=</span> US, O <span style=color:#f92672>=</span> DigiCert Inc, OU <span style=color:#f92672>=</span> www.digicert.com, CN <span style=color:#f92672>=</span> DigiCert High Assurance EV Root CA
</span></span><span style=display:flex><span>-----BEGIN CERTIFICATE-----
</span></span><span style=display:flex><span>... redacted ...
</span></span><span style=display:flex><span>-----END CERTIFICATE-----
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>Server certificate
</span></span><span style=display:flex><span>subject<span style=color:#f92672>=</span>C <span style=color:#f92672>=</span> US, ST <span style=color:#f92672>=</span> California, L <span style=color:#f92672>=</span> San Francisco, O <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;GitHub, Inc.&#34;</span>, CN <span style=color:#f92672>=</span> github.com
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>issuer<span style=color:#f92672>=</span>C <span style=color:#f92672>=</span> US, O <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;DigiCert, Inc.&#34;</span>, CN <span style=color:#f92672>=</span> DigiCert High Assurance TLS Hybrid ECC SHA256 <span style=color:#ae81ff>2020</span> CA1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>No client certificate CA names sent
</span></span><span style=display:flex><span>Peer signing digest: SHA256
</span></span><span style=display:flex><span>Peer signature type: ECDSA
</span></span><span style=display:flex><span>Server Temp Key: X25519, <span style=color:#ae81ff>253</span> bits
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>SSL handshake has read <span style=color:#ae81ff>2708</span> bytes and written <span style=color:#ae81ff>366</span> bytes
</span></span><span style=display:flex><span>Verification: OK
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>New, TLSv1.3, Cipher is TLS_AES_128_GCM_SHA256
</span></span><span style=display:flex><span>Server public key is <span style=color:#ae81ff>256</span> bit
</span></span><span style=display:flex><span>Secure Renegotiation IS NOT supported
</span></span><span style=display:flex><span>Compression: NONE
</span></span><span style=display:flex><span>Expansion: NONE
</span></span><span style=display:flex><span>No ALPN negotiated
</span></span><span style=display:flex><span>Early data was not sent
</span></span><span style=display:flex><span>Verify <span style=color:#66d9ef>return</span> code: <span style=color:#ae81ff>0</span> <span style=color:#f92672>(</span>ok<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>---
</span></span></code></pre></div><p>Everything smoothly and now I know the expected output. I don&rsquo;t understand all
of it but I can make some sense out of it. Now let&rsquo;s try on my gitlab instance.</p><h3 id=gitlabsubcomtech-certificates>gitlab.subcom.tech certificates</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>admin@ip-172-26-7-193:~$ openssl s_client -showcerts -servername gitlab.subcom.tech -connect gitlab.subcom.tech:443 &lt;/dev/null 2&gt;/dev/null
</span></span><span style=display:flex><span>CONNECTED<span style=color:#f92672>(</span>00000003<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>Certificate chain
</span></span><span style=display:flex><span> <span style=color:#ae81ff>0</span> s:CN <span style=color:#f92672>=</span> gitlab.subcom.tech
</span></span><span style=display:flex><span>   i:C <span style=color:#f92672>=</span> US, O <span style=color:#f92672>=</span> Let<span style=color:#e6db74>&#39;s Encrypt, CN = R3
</span></span></span><span style=display:flex><span><span style=color:#e6db74>-----BEGIN CERTIFICATE-----
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... redacted ...
</span></span></span><span style=display:flex><span><span style=color:#e6db74>-----END CERTIFICATE-----
</span></span></span><span style=display:flex><span><span style=color:#e6db74>---
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Server certificate
</span></span></span><span style=display:flex><span><span style=color:#e6db74>subject=CN = gitlab.subcom.tech
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>issuer=C = US, O = Let&#39;</span>s Encrypt, CN <span style=color:#f92672>=</span> R3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>No client certificate CA names sent
</span></span><span style=display:flex><span>Peer signing digest: SHA256
</span></span><span style=display:flex><span>Peer signature type: RSA-PSS
</span></span><span style=display:flex><span>Server Temp Key: X25519, <span style=color:#ae81ff>253</span> bits
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>SSL handshake has read <span style=color:#ae81ff>1884</span> bytes and written <span style=color:#ae81ff>390</span> bytes
</span></span><span style=display:flex><span>Verification error: unable to verify the first certificate
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>New, TLSv1.3, Cipher is TLS_AES_256_GCM_SHA384
</span></span><span style=display:flex><span>Server public key is <span style=color:#ae81ff>2048</span> bit
</span></span><span style=display:flex><span>Secure Renegotiation IS NOT supported
</span></span><span style=display:flex><span>Compression: NONE
</span></span><span style=display:flex><span>Expansion: NONE
</span></span><span style=display:flex><span>No ALPN negotiated
</span></span><span style=display:flex><span>Early data was not sent
</span></span><span style=display:flex><span>Verify <span style=color:#66d9ef>return</span> code: <span style=color:#ae81ff>21</span> <span style=color:#f92672>(</span>unable to verify the first certificate<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>---
</span></span></code></pre></div><p>All right, the problem seems to be that we are <strong>unable to verify the first
certificate.</strong>. Seems like there are multiple of certificates involved; and we
are unable to verify the first certificate itself!</p><p>To add to the confusion, the site works fine in browser
<code>https://gitlab.subcom.tech</code>. This means that certificates (I downloaded them
using <code>certbot</code>) are at least fine for browser. The git clone behaviour is
<em>definately</em> different than the browser.</p><p>I did an internet sortie. Some useful pointers:
<a href=https://docs.microsoft.com/en-us/archive/blogs/phkelley/adding-a-corporate-or-self-signed-certificate-authority-to-git-exes-store target=_blank>https://docs.microsoft.com/en-us/archive/blogs/phkelley/adding-a-corporate-or-self-signed-certificate-authority-to-git-exes-store</a>
offers a solution. But still very confused.</p><p>I search in gitlab documentation. Their documentation is good and I got a
helpful hit:
<strong><a href=https://docs.gitlab.com/omnibus/settings/ssl.html#common-ssl-errors target=_blank>https://docs.gitlab.com/omnibus/settings/ssl.html#common-ssl-errors</a></strong>. I had
to google few terms and read a bit more. For a person like me who has short
attention span, this is the hardest part. But after spending enough hours, I
finally figured out the solution.</p><h1 id=solution>Solution</h1><pre tabindex=0><code class=language-terminal data-lang=terminal>admin@ip-172-26-7-193:/etc/gitlab/ssl$ ls /etc/gitlab/ssl/ -l
total 4
lrwxrwxrwx 1 root root   54 Apr  4 19:21 gitlab.subcom.tech.crt -&gt; /etc/letsencrypt/live/gitlab.subcom.tech/cert.pem
lrwxrwxrwx 1 root root   52 Mar 12 15:25 gitlab.subcom.tech.key -&gt; /etc/letsencrypt/live/gitlab.subcom.tech/privkey.pem
-r-------- 1 root root 1675 Mar 15 15:40 gitlab.subcom.tech.key-staging
</code></pre><p>Note that <code>gitlab.subcom.tech.crt</code> and <code>gitlab.subcom.tech.key</code> are links to
certificate and keys downloaded using <code>certbot</code>. The problem here is with
<code>cert.pem</code> which does not contain the &ldquo;chain&rdquo; of certificates but rather a
single certificate. This worked in browser but not using <code>git</code> (curious!).</p><p>After I realized that the chain of certificate is missing, I changed the
<code>gitlab.subcom.tech.crt</code> link.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>admin@ip-172-26-7-193:/etc/gitlab/ssl$ ls /etc/gitlab/ssl/ -l
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>lrwxrwxrwx <span style=color:#ae81ff>1</span> root root   <span style=color:#ae81ff>54</span> Apr  <span style=color:#ae81ff>4</span> 19:21 gitlab.subcom.tech.crt -&gt; /etc/letsencrypt/live/gitlab.subcom.tech/fullchain.pem
</span></span><span style=display:flex><span>lrwxrwxrwx <span style=color:#ae81ff>1</span> root root   <span style=color:#ae81ff>52</span> Mar <span style=color:#ae81ff>12</span> 15:25 gitlab.subcom.tech.key -&gt; /etc/letsencrypt/live/gitlab.subcom.tech/privkey.pem
</span></span><span style=display:flex><span>-r-------- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>1675</span> Mar <span style=color:#ae81ff>15</span> 15:40 gitlab.subcom.tech.key-staging
</span></span></code></pre></div><p>Now the file (rather a link) <code>/etc/gitlab/ssl/gitlab.subcom.tech.crt</code> points to
<code>/etc/letsencrypt/live/gitlab.subcom.tech/fullchain.pem</code> rather than to
<code>/etc/letsencrypt/live/gitlab.subcom.tech/cert.pem</code>. This solved the issue for
me. <code>fullchain.pem</code> has all the certificates needed for verification to be
successful.</p><p>Finally, I did a <code>gitlab-ctl reconfigure</code> followed by <code>gitlab.ctl restart</code>. I
can now clone the repositories over https protocol from &lsquo;gitlab.subcom.tech&rsquo;
server. Phew!</p></div></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="dilawarsblog",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to load the comments.</noscript></article></div></main><footer>© 2021, Dilawar Singh</footer><script src=/js/dark-mode.js></script></body></html>