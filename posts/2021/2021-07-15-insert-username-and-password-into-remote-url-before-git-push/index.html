<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<title>Insert credentials from environment into remote url when `git push` | Dilawar's Blog</title>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=generator content="Hugo 0.89.2">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=keywords content="git,script">
<link rel=stylesheet type=text/css media=screen href=/css/normalize.css>
<link rel=stylesheet type=text/css media=screen href=/css/main.css>
<link rel=stylesheet type=text/css media=screen href=/css/all.css><link rel=stylesheet href=/css/katex.css crossorigin=anonymous>
<script defer src=/js/katex.js integrity=sha384-PFWG8XW41D5NzhNv5FegM1CUkw9nNLdWug8DuwnUoNEVop9n5frjcnbtsZtxTNjw crossorigin=anonymous></script>
<script defer src=/js/auto-render.js integrity=sha384-EN2q+JG5/3Z8gD7hT5WZqq+W+9wQR4P3IezfuZmGG5RkNXaaaks85seDJO7WkZlY crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script>
<meta property="og:title" content="Insert credentials from environment into remote url when `git push`">
<meta property="og:description" content="You are on a remote server. You don&rsquo;t want to store your credentials on that machine. You can temporary export your credentials as environment variable e.g. export GITHUB_USER=dilawar and export GITHUB_PASSWORD=ladidadadad.
Here is a small script that acts as a wrapper around git push. It modifies the remote url and insert username and password (read from env). No need to store ssh keys on remote server or git clone with https credentials.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://dilawar.github.io/posts/2021/2021-07-15-insert-username-and-password-into-remote-url-before-git-push/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-07-15T00:00:00+00:00">
<meta property="article:modified_time" content="2021-07-15T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Insert credentials from environment into remote url when `git push`">
<meta name=twitter:description content="You are on a remote server. You don&rsquo;t want to store your credentials on that machine. You can temporary export your credentials as environment variable e.g. export GITHUB_USER=dilawar and export GITHUB_PASSWORD=ladidadadad.
Here is a small script that acts as a wrapper around git push. It modifies the remote url and insert username and password (read from env). No need to store ssh keys on remote server or git clone with https credentials.">
<meta itemprop=name content="Insert credentials from environment into remote url when `git push`">
<meta itemprop=description content="You are on a remote server. You don&rsquo;t want to store your credentials on that machine. You can temporary export your credentials as environment variable e.g. export GITHUB_USER=dilawar and export GITHUB_PASSWORD=ladidadadad.
Here is a small script that acts as a wrapper around git push. It modifies the remote url and insert username and password (read from env). No need to store ssh keys on remote server or git clone with https credentials."><meta itemprop=datePublished content="2021-07-15T00:00:00+00:00">
<meta itemprop=dateModified content="2021-07-15T00:00:00+00:00">
<meta itemprop=wordCount content="410">
<meta itemprop=keywords content="git,script,">
</head>
<body>
<header>
<div id=titletext>
<h2 id=title><a href=https://dilawar.github.io>Dilawar's Blog</a></h2>
</div>
<div id=title-description>
<p id=subtitle>watch -n 1 /dev/null</p>
<div id=social>
<nav><ul>
<li><a href=https://github.com/dilawar><i title=Github class="icons fab fa-github"></i></a></li>
<li><a><i title="Switch Dark Mode" class="dark-mode icons fas fa-moon"></i></a></li>
</ul></nav>
</div>
</div>
<div id=mainmenu>
<nav>
<ul>
<li><a href=/>Home</a></li>
<li><a href=/posts>All posts</a></li>
<li><a href=/about>About</a></li>
<li><a href=/tags>Tags</a></li>
</ul>
</nav>
</div>
</header>
<main>
<div class=post>
<article>
<div class=post-header>
<div class=meta>
<div class=date>
<span class=day>15</span>
<span class=rest>Jul 2021</span>
</div>
</div>
<div class=matter>
<h1 class=title>Insert credentials from environment into remote url when `git push`</h1>
<p class=post-meta>
<span class=post-meta>
</span>
</p>
</div>
</div>
<div class=markdown>
<p>You are on a remote server. You don&rsquo;t want to store your credentials on that
machine. You can temporary export your credentials as environment variable e.g.
<code>export GITHUB_USER=dilawar</code> and <code>export GITHUB_PASSWORD=ladidadadad</code>.</p>
<p>Here is a small script that acts as a wrapper around <code>git push</code>. It modifies the
<code>remote</code> url and insert username and password (read from <code>env</code>). No need to
store ssh keys on remote server or git clone with https credentials.</p>
<p>For <code>github.com</code>, it looks for <code>GITHUB_USER</code> first, then for <code>GIT_USER</code>, and
then <code>USER</code> environment variable. Similarly it looks for <code>GITHUB_TOKEN</code>,
<code>GIT_TOKEN</code> for tokens. For <code>gitlab.com</code>, it looks for <code>GITLAB_USER</code> or
<code>GIT_USER</code> or <code>USER</code> for username, and <code>GITLAB_TOKEN</code>, <code>GIT_TOKEN</code> for password.</p>
<p>If the script can&rsquo;t determine the username and password, it throws an exception.</p>
<p>On success, it calls <code>git push</code> with new url (that has username and password).
For example <code>git push https://github.com/dilawar/Scripts</code> will become <code>git push https://dilawar:mytoken@github.com/dilawar/Scritps</code>.</p>
<p>You can find the script
<a href=https://raw.githubusercontent.com/dilawar/Scripts/master/%2Cgit_push target=_blank>here</a>.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#888>#!/usr/bin/env python3</span>
<span style=color:#888># pip3 install typer --user  # only dependency</span>

<span style=color:#080;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>sys</span>
<span style=color:#080;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>typing</span> <span style=color:#080;font-weight:700>as</span> <span style=color:#0e84b5;font-weight:700>T</span>
<span style=color:#080;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>subprocess</span>
<span style=color:#080;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>urllib.parse</span> <span style=color:#080;font-weight:700>import</span> urlparse
<span style=color:#080;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>os</span>

<span style=color:#080;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>typer</span>

app <span style=color:#333>=</span> typer<span style=color:#333>.</span>Typer()

git <span style=color:#333>=</span> <span style=background-color:#fff0f0>&#34;git&#34;</span>


<span style=color:#080;font-weight:700>def</span> <span style=color:#06b;font-weight:700>env</span>(key:<span style=color:#007020>str</span>, default<span style=color:#333>=</span><span style=color:#080;font-weight:700>None</span>) <span style=color:#333>-&gt;</span> T<span style=color:#333>.</span>Optional[<span style=color:#007020>str</span>]:
    <span style=color:#080;font-weight:700>return</span> os<span style=color:#333>.</span>environ<span style=color:#333>.</span>get(key, default)

<span style=color:#080;font-weight:700>def</span> <span style=color:#06b;font-weight:700>find_remote</span>() <span style=color:#333>-&gt;</span> <span style=color:#007020>str</span>:
    remote <span style=color:#333>=</span> subprocess<span style=color:#333>.</span>check_output([git, <span style=background-color:#fff0f0>&#34;remote&#34;</span>, <span style=background-color:#fff0f0>&#34;-v&#34;</span>], text<span style=color:#333>=</span><span style=color:#080;font-weight:700>True</span>)
    remote <span style=color:#333>=</span> [x <span style=color:#080;font-weight:700>for</span> x <span style=color:#000;font-weight:700>in</span> remote<span style=color:#333>.</span>split(<span style=background-color:#fff0f0>&#34;</span><span style=color:#666;background-color:#fff0f0;font-weight:700>\n</span><span style=background-color:#fff0f0>&#34;</span>) <span style=color:#080;font-weight:700>if</span> <span style=background-color:#fff0f0>&#34;(push)&#34;</span> <span style=color:#000;font-weight:700>in</span> x<span style=color:#333>.</span>strip()][<span style=color:#00d;font-weight:700>0</span>]
    remote <span style=color:#333>=</span> remote<span style=color:#333>.</span>split()[<span style=color:#00d;font-weight:700>1</span>]
    <span style=color:#080;font-weight:700>return</span> remote


<span style=color:#080;font-weight:700>def</span> <span style=color:#06b;font-weight:700>get_user</span>(domain) <span style=color:#333>-&gt;</span> T<span style=color:#333>.</span>Optional[<span style=color:#007020>str</span>]:
    <span style=color:#080;font-weight:700>if</span> domain <span style=color:#333>==</span> <span style=background-color:#fff0f0>&#34;github.com&#34;</span>:
        <span style=color:#080;font-weight:700>return</span> env(<span style=background-color:#fff0f0>&#34;GITHUB_USER&#34;</span>, env(<span style=background-color:#fff0f0>&#34;GIT_USER&#34;</span>, <span style=color:#080;font-weight:700>None</span>))
    <span style=color:#080;font-weight:700>if</span> domain <span style=color:#333>==</span> <span style=background-color:#fff0f0>&#34;gitlab.com&#34;</span>:
        <span style=color:#080;font-weight:700>return</span> env(<span style=background-color:#fff0f0>&#34;GITLAB_USER&#34;</span>, env(<span style=background-color:#fff0f0>&#34;GIT_USER&#34;</span>, <span style=color:#080;font-weight:700>None</span>))
    <span style=color:#080;font-weight:700>return</span> env(<span style=background-color:#fff0f0>&#39;GIT_USER&#39;</span>, env(<span style=background-color:#fff0f0>&#39;USER&#39;</span>, <span style=color:#080;font-weight:700>None</span>))

<span style=color:#080;font-weight:700>def</span> <span style=color:#06b;font-weight:700>get_token</span>(domain) <span style=color:#333>-&gt;</span> T<span style=color:#333>.</span>Optional[<span style=color:#007020>str</span>]:
    <span style=color:#080;font-weight:700>if</span> domain <span style=color:#333>==</span> <span style=background-color:#fff0f0>&#34;github.com&#34;</span>:
        <span style=color:#080;font-weight:700>return</span> env(<span style=background-color:#fff0f0>&#34;GITHUB_TOKEN&#34;</span>, env(<span style=background-color:#fff0f0>&#34;GIT_TOKEN&#34;</span>, <span style=color:#080;font-weight:700>None</span>))
    <span style=color:#080;font-weight:700>if</span> domain <span style=color:#333>==</span> <span style=background-color:#fff0f0>&#34;gitlab.com&#34;</span>:
        <span style=color:#080;font-weight:700>return</span> env(<span style=background-color:#fff0f0>&#34;GITLAB_TOKEN&#34;</span>, env(<span style=background-color:#fff0f0>&#34;GIT_TOKEN&#34;</span>, <span style=color:#080;font-weight:700>None</span>))
    <span style=color:#080;font-weight:700>return</span> env(<span style=background-color:#fff0f0>&#34;GIT_TOKEN&#34;</span>, <span style=color:#080;font-weight:700>None</span>)


<span style=color:#080;font-weight:700>def</span> <span style=color:#06b;font-weight:700>find_branch</span>() <span style=color:#333>-&gt;</span> <span style=color:#007020>str</span>:
    branches <span style=color:#333>=</span> (
        subprocess<span style=color:#333>.</span>check_output([git, <span style=background-color:#fff0f0>&#34;branch&#34;</span>, <span style=background-color:#fff0f0>&#34;-a&#34;</span>], text<span style=color:#333>=</span><span style=color:#080;font-weight:700>True</span>)<span style=color:#333>.</span>strip()<span style=color:#333>.</span>split(<span style=background-color:#fff0f0>&#34;</span><span style=color:#666;background-color:#fff0f0;font-weight:700>\n</span><span style=background-color:#fff0f0>&#34;</span>)
    )
    branch <span style=color:#333>=</span> [x<span style=color:#333>.</span>strip() <span style=color:#080;font-weight:700>for</span> x <span style=color:#000;font-weight:700>in</span> branches <span style=color:#080;font-weight:700>if</span> x<span style=color:#333>.</span>strip()[<span style=color:#00d;font-weight:700>0</span>] <span style=color:#333>==</span> <span style=background-color:#fff0f0>&#34;*&#34;</span>][<span style=color:#00d;font-weight:700>0</span>]
    <span style=color:#080;font-weight:700>return</span> branch[<span style=color:#00d;font-weight:700>1</span>:]<span style=color:#333>.</span>strip()  <span style=color:#888># remote leading *</span>


<span style=color:#080;font-weight:700>def</span> <span style=color:#06b;font-weight:700>rewrite_remote</span>(remote: <span style=color:#007020>str</span>) <span style=color:#333>-&gt;</span> <span style=color:#007020>str</span>:
    o <span style=color:#333>=</span> urlparse(remote)
    <span style=color:#080;font-weight:700>assert</span> o<span style=color:#333>.</span>scheme <span style=color:#000;font-weight:700>in</span> [<span style=background-color:#fff0f0>&#34;https&#34;</span>, <span style=background-color:#fff0f0>&#34;http&#34;</span>]
    U, P <span style=color:#333>=</span> get_user(o<span style=color:#333>.</span>netloc), get_token(o<span style=color:#333>.</span>netloc)
    <span style=color:#080;font-weight:700>assert</span> U <span style=color:#000;font-weight:700>is</span> <span style=color:#000;font-weight:700>not</span> <span style=color:#080;font-weight:700>None</span>, <span style=background-color:#fff0f0>&#34;Could not determine user&#34;</span>
    <span style=color:#080;font-weight:700>assert</span> P <span style=color:#000;font-weight:700>is</span> <span style=color:#000;font-weight:700>not</span> <span style=color:#080;font-weight:700>None</span>, <span style=background-color:#fff0f0>&#34;Could not determine token&#34;</span>
    <span style=color:#080;font-weight:700>return</span> o<span style=color:#333>.</span>geturl()<span style=color:#333>.</span>replace(<span style=background-color:#fff0f0>f</span><span style=background-color:#fff0f0>&#34;</span><span style=background-color:#eee>{</span>o<span style=color:#333>.</span>scheme<span style=background-color:#eee>}</span><span style=background-color:#fff0f0>://&#34;</span>, <span style=background-color:#fff0f0>f</span><span style=background-color:#fff0f0>&#34;</span><span style=background-color:#eee>{</span>o<span style=color:#333>.</span>scheme<span style=background-color:#eee>}</span><span style=background-color:#fff0f0>://</span><span style=background-color:#eee>{</span>U<span style=background-color:#eee>}</span><span style=background-color:#fff0f0>:</span><span style=background-color:#eee>{</span>P<span style=background-color:#eee>}</span><span style=background-color:#fff0f0>@&#34;</span>)

<span style=color:#080;font-weight:700>def</span> <span style=color:#06b;font-weight:700>git_push</span>(url, branch):
    cmd <span style=color:#333>=</span> <span style=background-color:#fff0f0>f</span><span style=background-color:#fff0f0>&#34;git push </span><span style=background-color:#eee>{</span>url<span style=background-color:#eee>}</span><span style=background-color:#fff0f0> </span><span style=background-color:#eee>{</span>branch<span style=background-color:#eee>}</span><span style=background-color:#fff0f0>&#34;</span>
    subprocess<span style=color:#333>.</span>run(cmd<span style=color:#333>.</span>split())

<span style=color:#555;font-weight:700>@app</span><span style=color:#333>.</span>command()
<span style=color:#080;font-weight:700>def</span> <span style=color:#06b;font-weight:700>main</span>(remote: T<span style=color:#333>.</span>Optional[<span style=color:#007020>str</span>] <span style=color:#333>=</span> <span style=color:#080;font-weight:700>None</span>, branch: T<span style=color:#333>.</span>Optional[<span style=color:#007020>str</span>] <span style=color:#333>=</span> <span style=color:#080;font-weight:700>None</span>):
    <span style=color:#888># get the remote</span>
    remote <span style=color:#333>=</span> find_remote() <span style=color:#080;font-weight:700>if</span> remote <span style=color:#000;font-weight:700>is</span> <span style=color:#080;font-weight:700>None</span> <span style=color:#080;font-weight:700>else</span> remote
    branch <span style=color:#333>=</span> find_branch() <span style=color:#080;font-weight:700>if</span> branch <span style=color:#000;font-weight:700>is</span> <span style=color:#080;font-weight:700>None</span> <span style=color:#080;font-weight:700>else</span> branch
    url <span style=color:#333>=</span> rewrite_remote(remote)
    git_push(url, branch)


<span style=color:#080;font-weight:700>if</span> __name__ <span style=color:#333>==</span> <span style=background-color:#fff0f0>&#34;__main__&#34;</span>:
    app()
</code></pre></div><h3 id=usage>Usage</h3>
<p>Save it as <code>gh_push.py</code> somewhere in <code>$PATH</code> and make it executable. Export
<code>GITHUB_USER</code> and <code>GITHUB_TOKEN</code>. And instead of <code>git push</code>. do</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>gh_push.py
</code></pre></div>
</div>
<div class=tags>
<div class=taxosfloating_left>
<p>Categories</p>
</div>
<div class=termsfloating_right>
<p>
<a href=/categories/script/>script</a>
</p>
</div>
<div class=clearit></div>
<div class=tags>
<div class=taxosfloating_left>
<p>Tags</p>
</div>
<div class=termsfloating_right>
<p>
<a href=/tags/git/>git</a>
<a href=/tags/script/>script</a>
</p>
</div>
<div class=clearit></div>
</div>
</article>
</div>
</main>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-180197482-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<script src=/js/dark-mode.js></script>
</body>
</html>